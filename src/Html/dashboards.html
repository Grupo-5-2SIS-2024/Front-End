<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="../Css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body onload="buscar(), buscarRosca()">
    <div class="dashboard">
        <h1>DASHBOARD</h1>
        <div class="grid-container">
            <div class="card executed-appointments">
                <div id="rosca"  class="line-chart">
                    <canvas id="GraficoRosca"></canvas>
                </div>
            </div>
            <div class="card upcoming-appointments">
                <p>Agendamentos recorrentes próximos ao vencimento:</p>
                <table id="tableUpcomingAppointments">
                    <tr>
                        <th>Paciente</th>
                        <th>Vencimento</th>
                        <th>Especialidade</th>
                    </tr>


                </table>
            </div>
            <div class="card patients-released">
                <div class="line-chart">
                    <canvas id="GraficoBarraHorizontal"></canvas>
                </div>
            </div>
            <div class="card retention">
                <div class="line-chart">
                    <canvas id="GraficoLinhaFidelizacao"></canvas>
                </div>
            </div>

            <div class="card grande">
                <div class="line-chart">
                    <canvas id="GraficoBarraDePe"></canvas>
                </div>
            </div>

        </div>
    </div>


</body>
</html>

<script>



function formatarData(dataISO){
const data = new Date(dataISO)
const dia = String(data.getDate()).padStart(2,'0');
const mes =String(data.getMonth() + 1). padStart(2,'0');
const ano = data.getFullYear();

const  horas = String(data.getHours()).padStart(2,'0')
const minutos = String(data.getMinutes()).padStart(2,'0')
const segundos = String(data.getSeconds()).padStart(2,'0')

return `${dia}/${mes}/${ano} - ${horas}:${minutos}:${segundos}`


}


      async function buscar() {
    console.log("passei por aqui");

    try {
        const resposta = await fetch("http://localhost:8080/consultas/agendamentosProximos");
        if (!resposta.ok) {
            throw new Error(`HTTP error! Status: ${resposta.status}`);
        }
        const respostaDados = await resposta.json();
        console.log(respostaDados);

        const cards = document.getElementById("tableUpcomingAppointments");
        cards.innerHTML = respostaDados.map((item) => {
            return `                     <tr>
                        <th>${item.nomePaciente}</th>
                        <th>${formatarData(item.dataConsulta)}</th>
                        <th>${item.especialidadeMedico}</th>
                    </tr> `;
        }).join('');
    } catch (error) {
        console.error('Failed to fetch:', error);
    }
}

console.log("antes de buscar");
buscar();
console.log("depois de buscar");






// GRAFICO 2

async function buscarRosca() {   
    console.log("passei por aqui");

    try {
        const resposta = await fetch("http://localhost:8080/consultas/percentagem-concluidos");
        const resposta2 = await fetch("http://localhost:8080/consultas/percentagem-concluidos2");
        const resposta3 = await fetch("http://localhost:8080/consultas/percentagem-concluidos3");
        if (!resposta.ok) {
            throw new Error(`HTTP error! Status: ${resposta.status}`);
        }
        if (!resposta2.ok) {
            throw new Error(`HTTP error! Status: ${resposta2.status}`);
        }
        if (!resposta3.ok) {
            throw new Error(`HTTP error! Status: ${resposta3.status}`);
        }
        const respostaDados = await resposta.json();
        console.log(respostaDados);
        const respostaDados2 = await resposta2.json();
        console.log(respostaDados2);
        const respostaDados3 = await resposta3.json();
        console.log(respostaDados3);
        const data = {
            labels: ['Pendentes', 'Concluidos', 'Cancelados'],
            datasets: [{
                label: 'Consultas',
                data: [respostaDados.percentagemConcluidos, respostaDados2.percentagemConcluidos, respostaDados3.percentagempendete ],
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(78, 362, 900)'
                ],
                hoverOffset: 4
            }]
        };

        const config = {
            type: 'doughnut',
            data: data,
        };

        const ctx = document.getElementById('GraficoRosca').getContext('2d');
        new Chart(ctx, config);
    } catch (error) {
        console.error('Failed to fetch:', error);
    }
}

console.log("antes de buscar");
buscarRosca();
console.log("depois de buscar");











// GRAFICO 3
async function buscarBarraY() {
    console.log("passei por aqui");

    try {
        const resposta = await fetch("http://localhost:8080/consultas/altas-ultimos-seis-meses");
        if (!resposta.ok) {
            throw new Error(`HTTP error! Status: ${resposta.status}`);
        }
        const respostaDados = await resposta.json();
        console.log(respostaDados);

        // Extracting the data correctly
        const labels = respostaDados.map(item => `Mês ${item.mes}`);
        const dataValues = respostaDados.map(item => item.total);

        const data = {
            labels: labels,
            datasets: [{
                axis: 'y',
                label: 'Consultas por Mês',
                data: dataValues,
                fill: false,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(255, 159, 64, 0.2)',
                    'rgba(255, 205, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(201, 203, 207, 0.2)'
                ],
                borderColor: [
                    'rgb(255, 99, 132)',
                    'rgb(255, 159, 64)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(54, 162, 235)',
                    'rgb(153, 102, 255)',
                    'rgb(201, 203, 207)'
                ],
                borderWidth: 1
            }]
        };

        const config = {
            type: 'bar',
            data: data,
            options: {
                indexAxis: 'y',
            }
        };

        const ctx = document.getElementById('GraficoBarraHorizontal').getContext('2d');
        new Chart(ctx, config);
    } catch (error) {
        console.error('Failed to fetch:', error);
    }
}

console.log("antes de buscar");
buscarBarraY();
console.log("depois de buscar");
























// GRAFICO 4



async function buscarLinhasFidelizacao() {
    console.log("passei por aqui");

    try {
        const resposta = await fetch("http://localhost:8080/pacientes/conversoes-ultimos-seis-meses");
        if (!resposta.ok) {
            throw new Error(`HTTP error! Status: ${resposta.status}`);
        }
        const respostaDados = await resposta.json();
        console.log(respostaDados);

        // Extracting the data correctly
        const labels = respostaDados.map(item => `Mês ${item.mes}`);
        const dataValues = respostaDados.map(item => item.total);

        const data = {
            labels: labels,
            datasets: [{
                label: 'Conversões por Mês',
                data: dataValues,
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        };

        const config = {
            type: 'line',
            data: data,
        };

        const ctx = document.getElementById('GraficoLinhaFidelizacao').getContext('2d');
        new Chart(ctx, config);
    } catch (error) {
        console.error('Failed to fetch:', error);
    }
}

console.log("antes de buscar");
buscarLinhasFidelizacao();
console.log("depois de buscar");



















// GRAFICO 5 





async function buscarBarra() {
    console.log("passei por aqui");

    try {
        const resposta = await fetch("http://localhost:8080/consultas/horarios-ultimos-seis-meses");
        if (!resposta.ok) {
            throw new Error(`HTTP error! Status: ${resposta.status}`);
        }
        const respostaDados = await resposta.json();
        console.log(respostaDados);

        // Extracting the data correctly
        const labels = respostaDados.map(item => `Mês ${item.mes}`);
        const dataValuesAgendados = respostaDados.map(item => item.agendados);
        const dataValuesDisponiveis = respostaDados.map(item => item.disponiveis);

        const ctx = document.getElementById('GraficoBarraDePe').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Agendados',
                            data: dataValuesAgendados,
                            backgroundColor: 'rgba(0, 204, 0, 0.6)',
                            borderColor: 'rgba(0, 204, 0, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Disponiveis',
                            data: dataValuesDisponiveis,
                            backgroundColor: 'rgba(0, 102, 0, 0.6)',
                            borderColor: 'rgba(0, 102, 0, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        
    } catch (error) {
        console.error('Failed to fetch:', error);
    }
}

console.log("antes de buscar");
buscarBarra();
console.log("depois de buscar");













</script>
