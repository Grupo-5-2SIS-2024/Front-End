<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="../Css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard">
        <h1>DASHBOARD</h1>
        <div class="grid-container">
            <div class="card executed-appointments">
                <div class="line-chart">
                    <canvas id="GraficoRosca"></canvas>
                </div>
            </div>
            <div class="card upcoming-appointments">
                <p>Agendamentos recorrentes próximos ao vencimento:</p>
                <table id="tableUpcomingAppointments">
                    <tr>
                        <th>Paciente</th>
                        <th>Vencimento</th>
                        <th>Especialidade</th>
                    </tr>
                </table>
            </div>
            <div class="card patients-released">
                <div class="line-chart">
                    <canvas id="GraficoBarraHorizontal"></canvas>
                </div>
            </div>
            <div class="card retention">
                <div class="line-chart">
                    <canvas id="GraficoLinhaFidelizacao"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const baseURL = "http://localhost:8080";

        async function fetchData(endpoint) {
            console.log(`Buscando dados de ${endpoint}...`);
            try {
                const response = await fetch(`${baseURL}${endpoint}`);
                if (!response.ok) throw new Error("Resposta de rede não foi ok");
                const data = await response.json();
                console.log("Dados buscados:", data);
                return data;
            } catch (error) {
                console.error(`Falha ao buscar dados de ${endpoint}:`, error);
                return [];
            }
        }

        function createLineChart(ctx, labels, dataPoints, label, borderColor) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label,
                        data: dataPoints,
                        fill: false,
                        borderColor,
                        tension: 0.1
                    }]
                }
            });
        }

        function createBarChart(ctx, labels, dataPoints, label, backgroundColor) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label,
                        data: dataPoints,
                        backgroundColor,
                        borderColor: backgroundColor,
                        tension: 0.1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createDoughnutChart(ctx, labels, dataPoints, backgroundColors) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: dataPoints,
                        backgroundColor: backgroundColors
                    }]
                }
            });
        }

        async function plotCharts() {
            const fidelizadosData = await fetchData("/pacientesFidelizados");
            const fidelizadosLabels = fidelizadosData.map(item => new Date(item.data).toLocaleDateString());
            const fidelizadosPoints = fidelizadosData.map(item => item.dado);
            createLineChart(document.getElementById('GraficoLinhaFidelizacao').getContext('2d'), fidelizadosLabels, fidelizadosPoints, 'Quantidade Pacientes Fidelizados', '#36D000');

            const altaData = await fetchData("/pacientesAlta");
            const altaLabels = altaData.map(item => new Date(item.data).toLocaleDateString());
            const altaPoints = altaData.map(item => item.dado);
            createBarChart(document.getElementById('GraficoBarraHorizontal').getContext('2d'), altaLabels, altaPoints, 'Quantidade Pacientes que receberam alta', '#36D000');

            const executadosData = await fetchData("/agendementosExecutados");
            const executadosLabels = executadosData.map(item => new Date(item.data).toLocaleDateString());
            const executadosPoints = executadosData.map(item => item.dado);
            createDoughnutChart(document.getElementById('GraficoRosca').getContext('2d'), executadosLabels, executadosPoints, ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']);
        }

        async function fetchAndDisplayUpcomingAppointments() {
            const appointmentsData = await fetchData("/agendamentos");
            const table = document.getElementById("tableUpcomingAppointments");
            table.innerHTML += appointmentsData.map(item => `
                <tr>
                    <td>${item.paciente}</td>
                    <td>${new Date(item.data).toLocaleDateString()}</td>
                    <td>${item.especialidade}</td>
                </tr>
            `).join('');
        }

        document.addEventListener("DOMContentLoaded", () => {
            plotCharts();
            fetchAndDisplayUpcomingAppointments();
        });
    </script>
</body>
</html>
